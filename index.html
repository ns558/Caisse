<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Commande</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 1.6rem;
      text-align: center;
      color: #2980b9;
      margin-bottom: 20px;
    }
    .articles, .consigne-buttons {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 15px;
      margin-bottom: 15px;
    }
    .article-button, .consigne-button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 14px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s;
      position: relative;
    }
    .article-button:hover:not(:disabled),
    .consigne-button:hover {
      background: #2980b9;
    }
    .article-button:disabled, .article-button.out-of-stock {
      background: #ccc;
      cursor: not-allowed;
    }
    .stock-badge {
      display: block;
      margin-top: 8px;
      background: #e67e22;
      color: white;
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 12px;
      text-align: center;
      pointer-events: none;
      user-select: none;
    }
    .panier {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    .panier ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .panier li {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px dashed #ccc;
    }
    .total-section {
      text-align: right;
      font-size: 1.3rem;
      font-weight: bold;
      color: #e74c3c;
      margin-top: 10px;
    }
    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 20px;
    }
    .buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      color: white;
      cursor: pointer;
    }
    .clear { background: #f31212; }
    .clear:hover { background: #e23434; }
    .delete { background: #e74c3c; }
    .delete:hover { background: #c0392b; }
    .checkout-buttons { /* Container for checkout and return change buttons */
        display: flex;
        justify-content: space-between;
        align-items: center; /* Align items vertically */
        gap: 10px; /* Space between the buttons */
        margin-top: 20px;
    }
    .checkout {
      background: #2ecc71;
      flex: 2; /* Make the "Payer" button wider */
      padding: 20px 0;
      border-radius: 8px;
      font-size: 1.2rem;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .checkout:hover { background: #27ae60; }
    .payment-help { /* Style for the new payment help button */
        background: #9b59b6; /* A distinct color, e.g., purple */
        flex: 1; /* Make it smaller relative to checkout */
        padding: 20px 0; /* Same height as checkout button */
        border-radius: 8px; /* Same border-radius as checkout button */
        font-size: 0.9rem; /* Smaller font size */
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
    }
    .payment-help:hover {
        background: #8e44ad;
    }

    .stock-management {
      margin-top: 30px;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
    }
    .stock-management h2 {
      text-align: center;
      font-size: 1.2rem;
      color: #2980b9;
      margin-bottom: 15px;
    }
    .stock-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .stock-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .stock-list input {
      width: 60px;
      padding: 5px;
      text-align: center;
      margin-right: 10px;
    }
    .stock-list button {
      background: #9b59b6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .stock-list button:hover {
      background: #8e44ad;
    }

    /* Styles pour l'historique des commandes */
    .history-section {
      margin-top: 30px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .history-header h2 {
      margin: 0;
      font-size: 1.2rem;
      color: #2980b9;
    }
    .history-buttons {
      display: flex;
      gap: 10px; /* Espace entre les boutons d'historique */
    }
    .history-buttons .toggle-history-btn {
      background: #4982ed;
      color: white;
      border: none;
      padding: 5px 10px; 
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem; /* Taille de police pour le +/- */
      width: 35px; /* Largeur fixe pour un bouton carré */
      height: 35px; /* Hauteur fixe pour un bouton carré */
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .history-buttons .toggle-history-btn:hover {
      background: #302188;
    }
    .history-buttons .reset-history-btn {
      background: #dc3545; /* Rouge pour réinitialiser */
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .history-buttons .reset-history-btn:hover {
      background: #c82333;
    }
    .history-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 0;
      list-style: none;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .history-card {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      font-size: 0.9rem;
    }
    .history-card strong {
      display: block;
      margin-bottom: 5px;
      color: #2980b9;
    }
    .history-card ul {
      list-style: none;
      padding: 0;
      margin: 5px 0;
    }
    .history-card li {
      padding: 2px 0;
      border-bottom: none;
    }
    .history-card .total-history {
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
      color: #e74c3c;
    }
    .history-list.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Commande</h1>

    <div class="articles" id="article-buttons"></div>

    <div class="consigne-buttons">
      <button onclick="addConsigne()" class="consigne-button">Consigne +2.-</button>
      <button onclick="removeConsigne()" class="consigne-button">Consigne -2.-</button>
    </div>

    <div class="buttons">
      <button class="clear" onclick="clearCart()">Effacer tout</button>
      <button class="delete" onclick="removeLastArticle()">Effacer dernier</button>
    </div>

    <div class="panier">
      <h2>Panier</h2>
      <ul id="panier-list"></ul>
    </div>

    <div class="total-section">Total : <span id="total-amount">0.00.-</span></div>

    <div class="checkout-buttons">
        <button class="checkout" onclick="checkout()">Terminer la commande</button>
        <button class="payment-help" onclick="calculateChange()"> Aide au paiement</button>
    </div>

    <div class="stock-management">
      <h2>Stock actuel</h2>
      <ul class="stock-list" id="stock-update-list"></ul>
    </div>
    <div class="history-section">
      <div class="history-header">
        <h2>Historique des commandes</h2>
        <div class="history-buttons">
          <button id="toggle-history-btn" class="toggle-history-btn" onclick="toggleHistory()">+</button>
          <button class="reset-history-btn" onclick="resetHistory()">Réinitialiser</button>
        </div>
      </div>
      <div id="history-content">
        <ul id="command-history-list" class="history-list hidden">
          </ul>
      </div>
    </div>

  </div>

  <script>
    const articles = [
      { id: 'frites', name: 'Frites', price: 5, stock: -1 },
      { id: 'saucisse', name: 'Saucisse pain', price: 6, stock: -1 },
      { id: 'saucisse_frites', name: 'Saucisse frites', price: 10, stock: -1 },
      { id: 'roastbeef', name: 'Roastbeef frites', price: 22, stock: 10 },
      { id: 'crepe_jambon', name: 'Crêpe jambon', price: 6, stock: -1 },
      { id: 'crepe_jambon_fromage', name: 'Crêpe jambon + fromage', price: 7, stock: -1 },
      { id: 'crepe_sucre', name: 'Crêpe sucre', price: 5, stock: -1 },
      { id: 'crepe_confiture', name: 'Crêpe confiture', price: 5, stock: -1 }
    ];

    let cartItems = [];
    let itemHistory = []; // Historique des ajouts au panier (pour le bouton "effacer dernier")
    let commandHistory = JSON.parse(localStorage.getItem('commandHistory')) || []; // Historique des commandes payées
    let total = 0;

    function initializeArticleButtons() {
      const container = document.getElementById('article-buttons');
      container.innerHTML = '';
      articles.forEach(article => {
        const button = document.createElement('button');
        button.className = 'article-button';

        let cartItem = cartItems.find(ci => ci.articleId === article.id);
        let qtyInCart = cartItem ? cartItem.quantity : 0;
        let stockRestant = article.stock !== -1 ? article.stock - qtyInCart : Infinity;

       button.textContent = `${article.name} ${article.price.toFixed(2)} .-`;

        if (article.id === 'roastbeef' && article.stock >= 0) {
          const badge = document.createElement('span');
          badge.className = 'stock-badge';
          badge.textContent = `Stock: ${stockRestant}`;
          button.appendChild(badge);
        }

        if (stockRestant <= 0) {
          button.disabled = true;
          button.classList.add('out-of-stock');
        }
        button.onclick = () => addToCart(article);
        container.appendChild(button);
      });
    }

    function addToCart(article) {
      let cartItem = cartItems.find(ci => ci.articleId === article.id);
      let qtyInCart = cartItem ? cartItem.quantity : 0;
      let stockRestant = article.stock !== -1 ? article.stock - qtyInCart : Infinity;

      if (stockRestant <= 0) return;

      if (cartItem) {
        cartItem.quantity++;
      } else {
        cartItems.push({ articleId: article.id, quantity: 1, name: article.name, price: article.price });
      }

      itemHistory.push(article.id);
      updateCart();
      initializeArticleButtons();
      initializeStockManagement();
    }

    function addConsigne() {
      let cartItem = cartItems.find(ci => ci.articleId === '__consigne');
      if (cartItem) {
        cartItem.quantity++;
      } else {
        cartItems.push({ articleId: '__consigne', quantity: 1, customPrice: 2, name: 'Consigne' });
      }
      itemHistory.push('__consigne');
      updateCart();
    }

    function removeConsigne() {
      let cartItem = cartItems.find(ci => ci.articleId === '__rabais');
      if (cartItem) {
        cartItem.quantity++;
      } else {
        cartItems.push({ articleId: '__rabais', quantity: 1, customPrice: -2, name: 'Rabais' });
      }
      itemHistory.push('__rabais');
      updateCart();
    }

    function removeLastArticle() {
      if (!itemHistory.length) return;
      const lastAddedId = itemHistory.pop();
      const cartItem = cartItems.find(ci => ci.articleId === lastAddedId);
      
      if (!cartItem) return;

      cartItem.quantity--;
      if (cartItem.quantity <= 0) {
        cartItems.splice(cartItems.findIndex(x => x.articleId === lastAddedId), 1);
      }
      updateCart();
      initializeArticleButtons();
      initializeStockManagement();
    }

    function clearCart() {
      cartItems = [];
      itemHistory = [];
      updateCart();
      initializeArticleButtons();
      initializeStockManagement();
    }

    function updateCart() {
      const ul = document.getElementById('panier-list');
      ul.innerHTML = '';
      total = 0;

      if (cartItems.length === 0) {
        ul.innerHTML = '<li>Panier vide.</li>';
        document.getElementById('total-amount').textContent = '0.00 .-';
        return;
      }

      cartItems.forEach(cartItem => {
        const li = document.createElement('li');
        let lineTotal = 0;
        let itemName = '';

        if (cartItem.articleId === '__consigne') {
          lineTotal = cartItem.customPrice * cartItem.quantity;
          itemName = 'Consigne';
        } else if (cartItem.articleId === '__rabais') {
          lineTotal = cartItem.customPrice * cartItem.quantity;
          itemName = 'Retour consigne';
        } else {
          const article = articles.find(x => x.id === cartItem.articleId);
          lineTotal = article.price * cartItem.quantity;
          itemName = article.name;
        }

        li.innerHTML = `<span>${itemName} x${cartItem.quantity}</span><span>${lineTotal.toFixed(2)} .-</span>`;
        total += lineTotal;
        ul.appendChild(li);
      });
      document.getElementById('total-amount').textContent = total.toFixed(2) + ' .-';
    }

    function checkout() {
      if (total === 0) {
        alert("Panier vide !");
        return;
      }

      // No prompt for given amount, simply records the sale as an exact payment
      alert(`Commande payée pour ${total.toFixed(2)} .-`);

      // Enregistrer la commande dans l'historique
      const now = new Date();
      const command = {
        date: now.toLocaleDateString('fr-CH'),
        time: now.toLocaleTimeString('fr-CH', { hour: '2-digit', minute: '2-digit' }),
        items: cartItems.map(item => {
            const articleInfo = articles.find(a => a.id === item.articleId);
            return {
              name: item.name || (articleInfo ? articleInfo.name : ''),
              quantity: item.quantity,
              price: item.customPrice !== undefined ? item.customPrice : (articleInfo ? articleInfo.price : 0)
            };
        }),
        total: total,
        given: total, // Assuming exact payment for 'Payer' button
        change: 0,    // No change for 'Payer' button
        type: 'payment'
      };
      commandHistory.push(command);
      localStorage.setItem('commandHistory', JSON.stringify(commandHistory));
      renderCommandHistory(); // Mettre à jour l'affichage de l'historique

      clearCart();
    }

    function calculateChange() {
        if (total === 0) {
            alert("Le panier est vide. Il n'y a pas de monnaie à calculer.");
            return;
        }

        let given = prompt(`Total à payer : ${total.toFixed(2)} .-\nMontant donné par le client ?`);
        if (given === null) { // User clicked cancel
            return;
        }

        given = parseFloat(given);
        if (isNaN(given) || given < total) {
            alert("Montant invalide ou insuffisant.");
            return;
        }

        const change = given - total;
        alert(`Montant donné : ${given.toFixed(2)} .-\nMonnaie à rendre : ${change.toFixed(2)} .-`);

        // Removed the part that records this action to commandHistory
        // Also removed the clearCart() call from here
    }


    function initializeStockManagement() {
      const ul = document.getElementById('stock-update-list');
      ul.innerHTML = '';
      const roastbeefArticle = articles.find(x => x.id === 'roastbeef');
      const li = document.createElement('li');
      li.innerHTML = `
        <span>${roastbeefArticle.name}</span>
        <input type="number" id="roast-stock" value="${roastbeefArticle.stock}" min="0"/>
        <button onclick="updateRoastStock()">Maj</button>`;
      ul.appendChild(li);
    }

    function updateRoastStock() {
      const roastbeefArticle = articles.find(x => x.id === 'roastbeef');
      const value = parseInt(document.getElementById('roast-stock').value);
      if (!isNaN(value) && value >= 0) {
        roastbeefArticle.stock = value;
      }
      initializeArticleButtons();
      initializeStockManagement();
    }

    function renderCommandHistory() {
      const historyList = document.getElementById('command-history-list');
      historyList.innerHTML = '';

      if (commandHistory.length === 0) {
        historyList.innerHTML = '<p style="text-align: center; color: #666;">Aucune commande historique.</p>';
        return;
      }

      commandHistory.slice().reverse().forEach(command => { // Afficher les plus récentes en premier
        const card = document.createElement('div');
        card.className = 'history-card';

        let itemsHtml = '<ul>';
        command.items.forEach(item => {
          itemsHtml += `<li>${item.name} x${item.quantity} (${(item.price * item.quantity).toFixed(2)} .-)</li>`;
        });
        itemsHtml += '</ul>';

        let totalDisplay = '';
        if (command.type === 'payment') {
            totalDisplay = `
                <div class="total-history">Total payé: ${command.total.toFixed(2)} .-</div>
            `;
        } else if (command.type === 'changeCalculation') {
            // This part should technically not be reached if `calculateChange` doesn't log
            // However, existing history entries of type 'changeCalculation' will still be displayed correctly.
            totalDisplay = `
                <div class="total-history" style="color: #337ab7;">Total commande: ${command.total.toFixed(2)} .-</div>
                <div class="total-history" style="font-size: 0.9em; color: #6c757d;">Montant donné: ${command.given.toFixed(2)} .-</div>
                <div class="total-history" style="font-size: 0.9em; color: #28a745;">Monnaie à rendre: ${command.change.toFixed(2)} .-</div>
            `;
        }


        card.innerHTML = `
          <strong>${command.date} ${command.time}</strong>
          ${itemsHtml}
          ${totalDisplay}
        `;
        historyList.appendChild(card);
      });
    }

    function toggleHistory() {
      const historyList = document.getElementById('command-history-list');
      const toggleButton = document.getElementById('toggle-history-btn');
      if (historyList.classList.contains('hidden')) {
        historyList.classList.remove('hidden');
        toggleButton.textContent = '-'; // Change le texte du bouton en "-"
      } else {
        historyList.classList.add('hidden');
        toggleButton.textContent = '+'; // Change le texte du bouton en "+"
      }
    }

    function resetHistory() {
      if (confirm("Êtes-vous sûr de vouloir supprimer tout l'historique des commandes ?")) {
        commandHistory = [];
        localStorage.removeItem('commandHistory');
        renderCommandHistory();
        alert("Historique des commandes supprimé.");
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeArticleButtons();
      initializeStockManagement();
      updateCart();
      renderCommandHistory();
    });
  </script>
</body>
</html>
